'use strict';(function(l,d){"object"===typeof exports&&"undefined"!==typeof module?module.exports=d():"function"===typeof define&&define.amd?define(d):(l="undefined"!==typeof globalThis?globalThis:l||self,l.vue_dsl=d())})(this,function(){function l(a,b,e,g,c,h,d){try{var f=a[h](d),k=f.value}catch(t){e(t);return}f.done?b(k):Promise.resolve(k).then(g,c)}function d(a){return function(){var b=this,e=arguments;return new Promise(function(g,c){function h(a){l(f,g,c,h,d,"next",a)}function d(a){l(f,g,c,h,
d,"throw",a)}var f=a.apply(b,e);h(void 0)})}}function q(a,b){var e=Object.keys(a);if(Object.getOwnPropertySymbols){var g=Object.getOwnPropertySymbols(a);b&&(g=g.filter(function(c){return Object.getOwnPropertyDescriptor(a,c).enumerable}));e.push.apply(e,g)}return e}function f(a){for(var b=1;b<arguments.length;b++){var e=null!=arguments[b]?arguments[b]:{};b%2?q(Object(e),!0).forEach(function(b){var c=e[b];b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c}):
Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(e)):q(Object(e)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(e,b))})}return a}function u(a){return p.apply(this,arguments)}function p(){p=d(function*(a){var b=a.x_state,e={hint:"Allowed node type that must be ommited",func:function(){var b=d(function*(b){return a.reply_template({hasChildren:!1})});return function(a){return b.apply(this,arguments)}}()};return{cancel:f(f({},
e),{x_icons:"button_cancel"}),def_config:f(f({},e),{x_icons:"desktop_new",x_level:"2",x_text_contains:"config"}),def_modelos:f(f({},e),{x_icons:"desktop_new",x_level:"2",x_text_contains:"modelos"}),def_assets:f(f({},e),{x_icons:"desktop_new",x_level:"2",x_text_contains:"assets"}),def_server:{x_icons:"desktop_new",x_level:"2",x_text_contains:"server|servidor|api",hint:"Representa a un backend integrado con funciones de express.",func:function(){var e=d(function*(c){c=a.reply_template();b.npm=f(f({},
b.npm),{body_parser:"*","cookie-parser":"*"});b.central_config.static=!1;return c});return function(a){return e.apply(this,arguments)}}()},def_path:{x_icons:"list",x_level:"3,4",x_or_isparent:"def_server",x_not_icons:"button_cancel,desktop_new,help",hint:"Carpeta para ubicacion de funcion de servidor",func:function(){var e=d(function*(c){var e=a.reply_template();if(2==c.level)b.current_folder=c.text;else if(3==c.level&&(yield a.isExactParentID(c.id,"def_path"))){var g=yield a.dsl_parser.getParentNode({id:c.id});
b.current_folder="".concat(g.text,"/").concat(c.id)}else e.valid=!1;return e});return function(a){return e.apply(this,arguments)}}()},def_imagen:{x_icons:"idea",x_not_icons:"button_cancel,desktop_new,help",x_not_empty:"attributes[:src]",x_empty:"",x_level:">2",func:function(){var b=d(function*(b){return a.reply_template({otro:"Pablo"})});return function(a){return b.apply(this,arguments)}}()}}});return p.apply(this,arguments)}var v=require("concepto");class w extends v{constructor(a){var b=1<arguments.length&&
void 0!==arguments[1]?arguments[1]:{};b=f(f({},{class:"vue",debug:!0}),b);super(a,b)}onInit(){var a=this;return d(function*(){yield a.addCommands(u);a.x_crypto_key=require("crypto").randomBytes(32);a.x_state={plugins:{},npm:{},dev_npm:{},envs:{}};a.x_state.config_node=yield a._readConfig();a.x_state.central_config=yield a._readCentralConfig();a.x_state.assets=yield a._readAssets();a.x_state.dirs=a.x_state.central_config.componente?yield a._appFolders({components:"",pages:"",assets:"assets/","static":"static/",
umd:"umd/"}):yield a._appFolders({client:"client/",layouts:"client/layouts/",components:"client/components/",pages:"client/pages/",plugins:"client/plugins/","static":"client/static/",middleware:"client/middleware/",server:"client/server/",assets:"client/assets/",css:"client/assets/css/",store:"client/store/",lang:"client/lang/"});a.x_state.models=yield a._readModelos();a.x_state.nuxt_is_running=yield a._isLocalServerRunning();a.debug("is Server Running: "+a.x_state.nuxt_is_running);if(a.x_state.config_node.copiar){var b=
require("path"),e=b.dirname(b.resolve(a.x_flags.dsl)),g=require("recursive-copy");a.x_console.outT({message:"copying config:copiar directories to 'static' target folder",color:"yellow"});yield Object.keys(a.x_state.config_node.copiar).map(function(){var a=d(function*(a){a=b.join(e,a);try{yield g(a,this.x_state.dirs.static)}catch(r){"EEXIST"!=r.code&&this.x_console.outT({message:"error: copying directory ".concat(a),data:r})}});return function(b){return a.apply(this,arguments)}}().bind(a));a.x_console.outT({message:"copying config:copiar directories ... READY",
color:"yellow"})}if(a.x_state.config_node["nuxt:icon"]){a.x_state.npm["@nuxtjs/pwa"]="*";var c=require("path"),h=c.dirname(c.resolve(a.x_flags.dsl));c=c.join(h,a.x_state.config_node["nuxt:icon"]);h=a.x_state.dirs.static+"icon.png";a.debug({message:"NUXT ICON dump (copy icon)",color:"yellow",data:c});var f=require("fs").promises;try{yield f.copyFile(c,h)}catch(k){a.x_console.outT({message:"error: copying NUXT icon",data:k})}}a.x_state.config_node["google:adsense"]&&(a.x_state.npm["vue-google-adsense"]=
"*",a.x_state.npm["vue-script2"]="*");a.x_state.config_node["google:analytics"]&&(a.x_state.npm["@nuxtjs/google-gtag"]="*");a.x_state.central_config.componente?(a.x_console.outT({message:"vue initialized() -> as component/plugin"}),a.x_state.npm.global="^4.4.0",a.x_state.npm.poi="9",a.x_state.npm.underscore="*",a.x_state.dev_npm["@vue/test-utils"]="^1.0.0-beta.12",a.x_state.dev_npm["babel-core"]="^6.26.0",a.x_state.dev_npm["babel-preset-env"]="^1.6.1",a.x_state.dev_npm.jest="^22.4.0",a.x_state.dev_npm["jest-serializer-vue"]=
"^0.3.0",a.x_state.dev_npm.vue="*",a.x_state.dev_npm["vue-jest"]="*",a.x_state.dev_npm["vue-server-renderer"]="*",a.x_state.dev_npm["vue-template-compiler"]="*"):(a.x_console.outT({message:"vue initialized() ->"}),a.x_state.plugins["vue-moment"]={global:!0,npm:{"vue-moment":"*"},extra_imports:["moment"],requires:["moment/locale/es"],config:"{ moment }"},a.x_state.npm["@nuxtjs/axios"]="*",a.x_state.npm.nuxt="latest"==a.x_state.central_config.nuxt?"*":"2.11.0",a.x_state.npm.express="*",a.x_state.npm["serverless-http"]=
"*",a.x_state.npm["serverless-apigw-binary"]="*",a.x_state.npm.underscore="*",a.x_state.dev_npm["serverless-prune-plugin"]="*",a.x_state.dev_npm["serverless-offline"]="*",a.x_state.dev_npm["vue-beautify-loader"]="*",a.x_state.central_config.dominio&&(a.x_state.dev_npm["serverless-domain-manager"]="*"));c=function(b){["aurora","vpc","aws"].includes(b)&&"object"===typeof a.x_state.config_node[b]&&Object.keys(a.x_state.config_node[b]).map(function(a){this.x_state.envs["config.".concat(b,".").concat(a)]=
"process.env.".concat((b+"_"+a).toUpperCase())}.bind(a))};for(var m in a.x_state.config_node)c(m)})()}onAfterWritten(a){return d(function*(){return a})()}onDefineTitle(a){return d(function*(){var b=a.text,e;for(e in a.attributes)if(["title","titulo"].includes(a.attributes[e])){b=a.attributes[e];break}return b})()}onDefineFilename(a){return d(function*(){return a.text})()}onDefineNodeName(a){return d(function*(){return a.text.replace(" ","_")})()}onCompleteCodeTemplate(a){return d(function*(){return a})()}onPrepare(){return d(function*(){})()}onErrors(a){return d(function*(){})()}onCreateFiles(a){return d(function*(){})()}_isLocalServerRunning(){var a=
this;return d(function*(){return yield require("is-port-reachable")(a.x_state.central_config.port)})()}_readModelos(){var a=this;return d(function*(){a.debug("_readModelos");a.debug_time({id:"readModelos"});var b=yield a.dsl_parser.getNodes({text:"modelos",level:2,icon:"desktop_new",recurse:!0}),e,g={},c={tables:{},attributes:{},length:0,doc:""},h={id:{value:"INT AUTOINCREMENT PRIMARY KEY",alias:["identificador","autoid","autonum","key"]},texto:{value:"STRING",alias:["text","varchar","string"]},int:{value:"INTEGER",
alias:["numero chico","small int","numero"]},float:{value:"FLOAT",alias:["decimal","real"]},boolean:{value:"BOOLEAN",alias:["boleano","true/false"]},date:{value:"DATEONLY",alias:["fecha"]},datetime:{value:"DATETIME",alias:["fechahora"]},blob:{value:"BLOB",alias:["binario","binary"]}};Object.keys(h).map(function(a){var b=h[a].alias;b.push(a);b.map(b=>{g[b]=h[a].value})});if(0<b.length){b[0].attributes.map(a=>{c.attributes=f(f({},c.attributes),a)});c.doc=b[0].text_note;c.length=b[0].nodes.length;var d=
function(a){var b={};a.attributes.map(a=>{b=f(f({},b),a)});c.tables[a.text]={fields:{}};e=[];for(var d in b)c.tables[a.text].fields[d]=g[b[d]],e.push(d+" "+g[b[d]]);c.tables[a.text].sql="CREATE TABLE ".concat(a.text,"(").concat(e.join(","),")")},m;for(m of b[0].nodes)d(m)}a.debug_timeEnd({id:"readModelos"});if(0<c.length){b=[];for(var k in c.tables)b.push("alasqlJs('".concat(c.tables[k].sql,"');"));k="const alasql = {\n\t\t\t\tinstall (v) {\n\t\t\t\t\t// create tables from models\n\t\t\t\t\t".concat(b.join("\n"),
"\n\t\t\t\t\tVue.prototype.alasql = alasqlJs;\n\t\t\t\t}\n\t\t\t}");a.x_state.plugins["../../node_modules/alasql/dist/alasql.min.js"]={global:!0,npm:{alasql:"*"},var:"alasqlJs",mode:"client",customvar:"alasql",custom:k}}return c})()}_readAssets(){var a=this;return d(function*(){var b={},e=require("path");a.debug("_readAssets");a.debug_time({id:"_readAssets"});var g=yield a.dsl_parser.getNodes({text:"assets",level:2,icon:"desktop_new",recurse:!0}),c=e.sep;if(0<g.length){g=g[0];for(var d of g.nodes)if(1==
d.nodes.length&&""!=d.nodes[0].image)b[d.text.toLowerCase()]={i18n:!1,original:d.nodes[0].image,css:"~assets"+c+e.basename(d.nodes[0].image),js:"~"+c+"assets"+c+e.basename(d.nodes[0].image)};else if(1<d.nodes.length){var n=d.text.toLowerCase();b[n]={i18n:!0,i18n_keys:[]};g=function(a){var d={};a.attributes.map(function(a){d=f(f({},d),a)});if(d.idioma&&""!=a.image){var g=d.idioma.toLowerCase();b[n].i18n_keys.push(g);b[n][g]={original:a.image,css:"~assets"+c+e.basename(a.image),js:"~"+c+"assets"+c+
e.basename(a.image)}}};for(var m of d.nodes)g(m);b[n].i18n_keys=b[n].i18n_keys.join(",")}else""!=d.link&&(b[d.text.toLowerCase()]={original:d.link,css:"~assets"+c+e.basename(d.link),js:"~"+c+"assets"+c+e.basename(d.link)})}a.debug_timeEnd({id:"_readAssets"});return b})()}_readCentralConfig(){var a=this;return d(function*(){a.debug("_readCentralConfig");var b=yield a.dsl_parser.getNodes({level:1,recurse:!1}),e={cloud:"aws",type:"simple",i18n:!1,log:"console",debug:!1,deploy:!1,static:!1,timeout:30,
modelos:"aurora",componente:!1,"keep-alive":!0,"keep-warm":!0,port:3E3,git:!0,nuxt:"2.11.0",idiomas:"es",":cache":a.x_config.cache,":mode":"spa",":keywords":"",":author":"Punto Origen SpA",":license":"MIT",":github":"",":version":"1.0.0",":description":b[0].text_note,default_face:b[0].font.face,default_size:b[0].font.size,apptitle:b[0].text};b[0].attributes.map(function(a){e=f(f({},e),a)});e.service_name=e.dominio?e.dominio.replace(/\./g,"").toLowerCase():e.apptitle;e[":cache"]||(a.x_config.cache=
!1);return e})()}_readConfig(){var a=this;return d(function*(){a.debug("_readConfig");var b={id:"",meta:[],seo:{},secrets:{}},e={};e=yield a.dsl_parser.getNodes({text:"config",level:"2",icon:"desktop_new",recurse:!0});if(0<e.length){e=e[0];b.default_face=e.font.face;b.default_size=e.font.size;for(var d of e.nodes)if("meta"==d.text.toLowerCase())for(var c of d.nodes)"keywords"==c.text.toLowerCase()?(b.seo.keywords=c.nodes.map(a=>a.text),b.meta.push({hid:a.hash(c.nodes[0].text),name:"keywords",content:b.seo.keywords.join(",")})):
"language"==c.text.toLowerCase()?(b.seo.language=c.nodes[0].text,b.meta.push({hid:a.hash(c.nodes[0].text),lang:c.nodes[0].text})):"charset"==c.text.toLowerCase()?(b.seo.charset=c.nodes[0].text,b.meta.push({charset:c.nodes[0].text})):(b.seo.charset=c.nodes[0].text,-1!=c.text.indexOf(":")?b.meta.push({property:c.text,vmid:c.text,content:c.nodes[0].text}):b.meta.push({hid:a.hash(c.nodes[0].text),name:c.text,content:c.nodes[0].text}));else 0<d.attributes.length?function(){var a=d.text.toLowerCase().replace(/ /g,
""),c={};d.attributes.map(function(a){c=f(f({},c),a)});b[a]=c;d.icons.includes("password")&&(b[a][":secret"]=!0);""!=d.link&&(b[a][":link"]=d.link)}():0<d.nodes.length?b[d.text]=d.nodes[0].text:""!=d.link&&(b[d.text]=d.link)}if(!b.name){c=require("path");e=c.dirname(c.resolve(a.x_flags.dsl));var h=c.resolve(e,"../");e=e.replace(h,"");b.name=e.replace("/","").replace("\\","")+"_"+c.basename(a.x_flags.dsl,".dsl")}b.id||(b.id="com.puntorigen."+b.name);return b})()}hash(a){var b=require("highwayhash"),
d;"string"===typeof a?d=Buffer.from(a):"object"===typeof a&&(d=Buffer.from(JSON.stringify(a)));return b.asHexString(this.x_crypto_key,d)}}return w})
